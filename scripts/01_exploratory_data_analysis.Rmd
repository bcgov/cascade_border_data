---
title: "Cascade Gateway - explore"
output: html_notebook
---
<!--
Copyright 2020 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


The [Cascade Gateway Border Data Warehouse](http://www.cascadegatewaydata.com/Crossing) provides detailed, real-time data for the major Canada/U.S. border crossings between British Columbia and Washington in the Lower Mainland/Pacific Northwest.

* Lynden/Aldergrove

* Pacific Highway

* Peace Arch

* Sumas/Huntingdon

This is an initial exploration of the data, to understand the variables offered and how we might tabulate and visualize them.

Exploratory data analysis!

```{r setup}
# tidyverse packages
library(tidyverse)
library(lubridate)
library(glue)

# utilities
library(here)
library(janitor)

```

## Data import, #1

A csv file was downloaded via the "Custom Query" menu, with the following specifications:

* Date: 2018-01-01 to 2020-03-31 (note the website uses mdy format)

* Detector: none selected

* Crossing: Peach Arch / Northbound / Peace Arch North Cars & Peace Arch North NEXUS

* Weigh-in-Motion (WIM): none selected

The file was renamed "peacearch_N_cars_20190101_2020-03-31.csv"

```{r}

df_peacearch_prelim <- read_csv(here("data", "peacearch_N_cars_20180101_2020-03-31.csv"))

df_peacearch <- df_peacearch_prelim %>% 
  clean_names()

df_peacearch
```


Data manipulation

```{r}

df_peacearch_nbound <- df_peacearch %>% 
  mutate(ref_date = as_date(group_starts)) %>% 
  mutate(ref_year = year(ref_date),
         ref_mon = month(ref_date),
         ref_day = day(ref_date)) %>% 
  mutate(total_nbound = sum_volume_peace_arch_north_cars + sum_volume_peace_arch_north_nexus) %>% 
  select(ref_date, ref_year:ref_day, total_nbound)

```

quick plot
```{r}

ggplot(df_peacearch_nbound, aes(x = ref_date, y = total_nbound)) +
  geom_point() + 
  geom_smooth()

```



#### Failed detour

```{r}

df_peacearch_nbound2 <-
  df_peacearch_nbound %>% 
  # add leading zeros to month and day fields
  mutate(ref_mon2 = 
           case_when(
             ref_mon < 10 ~ glue("0{ref_mon}"),
             TRUE ~ as.character(ref_mon))) %>% 
  #
  mutate(ref_day2 = 
           case_when(
             ref_day < 10 ~ glue("0{ref_day}"),
             TRUE ~ as.character(ref_day))) %>% 
  # combine into single "month-day" character string
  unite(ref_mon_day, c(ref_mon2, ref_day2))
  
```



```{r}


ggplot(df_peacearch_nbound, aes(x = ref_mon_day, y = total_nbound, colour = ref_year)) +
  geom_point() + 
  geom_smooth()


```

Well that's not entirely successful... perhaps a more direct comparison using `dplyr::lag()`


### Lag

```{r}
df_peacearch_nbound <-
df_peacearch_nbound %>%
  mutate(yoy_chg = total_nbound - lag(total_nbound, n = 365))

df_peacearch_nbound

```

```{r}

p <- 
df_peacearch_nbound %>% 
  filter(ref_date >= as_date("2019-01-01")) %>% 
ggplot(aes(ref_date, yoy_chg)) +
  geom_point() +
  geom_smooth()

p 

p +
  labs(title = "Peace Arch, northbound cars",
       subtitle = "year-over-year same-day change",
       source = "http://www.cascadegatewaydata.com/")

ggsave("peace_arch_nbound.png")

```

